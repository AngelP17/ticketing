<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Operations Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: #0a0a0a;
        }

        .sidebar {
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
        }

        .card {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(50, 50, 50, 0.6);
        }

        .card:hover {
            border-color: rgba(120, 120, 120, 0.5);
        }

        .nav-item {
            transition: all 0.2s;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(80, 80, 80, 0.3) 0%, transparent 100%);
            border-left: 3px solid #a3a3a3;
        }

        .nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }

        .kpi-glow {
            box-shadow: 0 0 40px rgba(100, 100, 100, 0.1);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 3px;
        }

        .status-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .modal-window {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        .ticket-row {
            cursor: pointer;
        }

        .ticket-row:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Kanban Board */
        .kanban-column {
            min-height: 200px;
            background: rgba(15, 15, 15, 0.6);
            border: 1px solid rgba(50, 50, 50, 0.4);
            border-radius: 12px;
        }

        .kanban-card {
            background: rgba(25, 25, 25, 0.9);
            border: 1px solid rgba(60, 60, 60, 0.5);
            border-radius: 8px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s;
        }

        .kanban-card:hover {
            border-color: rgba(100, 100, 100, 0.7);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .kanban-card.sortable-ghost {
            opacity: 0.4;
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .kanban-card.sortable-chosen {
            cursor: grabbing;
        }

        .label-chip {
            display: inline-block;
            padding: 1px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .label-select-chip {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
            padding: 3px 10px;
        }

        .label-select-chip.selected {
            border-color: currentColor;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.2);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .attachment-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid rgba(60,60,60,0.5);
            cursor: pointer;
        }

        .attachment-preview:hover {
            border-color: rgba(100,100,100,0.7);
            transform: scale(1.05);
        }
    </style>
</head>

<body class="text-gray-300">
    <!-- Sidebar -->
    <div class="sidebar fixed inset-y-0 left-0 w-64 flex flex-col z-20">
        <div class="p-6 border-b border-neutral-800">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center">
                    <i class="fas fa-server text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white">IT Ops<span class="text-blue-400">Center</span></h1>
                    <p class="text-xs text-neutral-500">Enterprise Dashboard</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button onclick="switchView('dashboard')" id="nav-dashboard"
                class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm">
                <i class="fas fa-chart-pie w-5 text-neutral-300"></i> <span class="text-white font-medium">Dashboard</span>
            </button>
            <button onclick="switchView('tickets')" id="nav-tickets"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm">
                <i class="fas fa-ticket-alt w-5 text-neutral-500"></i> <span>All Tickets</span>
            </button>
            <button onclick="switchView('board')" id="nav-board"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm">
                <i class="fas fa-columns w-5 text-neutral-500"></i> <span>Board</span>
            </button>
            <button onclick="switchView('legend')" id="nav-legend"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm">
                <i class="fas fa-info-circle w-5 text-neutral-500"></i> <span>Color Legend</span>
            </button>
            <button onclick="switchView('team')" id="nav-team"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm">
                <i class="fas fa-users w-5 text-neutral-500"></i> <span>Team Workload</span>
            </button>
            <button onclick="switchView('users')" id="nav-users"
                class="admin-only nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm">
                <i class="fas fa-user-cog w-5 text-neutral-500"></i> <span>User Management</span>
            </button>
            <button onclick="switchView('settings')" id="nav-settings"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm">
                <i class="fas fa-cog w-5 text-neutral-500"></i> <span>Settings</span>
            </button>
        </nav>
        <div class="p-4 border-t border-neutral-800">
            <div class="flex items-center gap-3 px-2 mb-3">
                <div id="user-avatar"
                    class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
                    --</div>
                <div>
                    <p class="text-sm font-medium text-white" id="user-display-name">Loading...</p>
                    <p class="text-xs text-neutral-500" id="user-role">--</p>
                </div>
            </div>
            <button onclick="logout()"
                class="w-full text-left flex items-center gap-2 px-2 py-2 text-sm text-neutral-400 hover:text-red-400 transition">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-10 backdrop-blur-xl bg-neutral-950/80 border-b border-neutral-800 px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-white" id="page-title">Dashboard Overview</h2>
                    <p class="text-sm text-neutral-500" id="page-subtitle"></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-xs">
                        <span class="status-pulse w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="text-neutral-400">Live • Auto-refresh <span id="countdown">30</span>s</span>
                    </div>
                    <button id="btn-new-ticket" onclick="openNewTicketModal()"
                        class="admin-only bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition text-white">
                        <i class="fas fa-plus"></i> New Ticket
                    </button>
                    <a href="/api/export"
                        class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition text-white">
                        <i class="fas fa-file-excel"></i> Export
                    </a>
                    <button onclick="loadData()"
                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition text-white">
                        <i class="fas fa-sync-alt" id="refresh-icon"></i> Refresh
                    </button>
                </div>
            </div>
        </header>

        <main class="p-8">
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section">
                <!-- KPI Row -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div onclick="kpiClick('all')" class="card kpi-glow rounded-xl p-6 transition-all duration-300 cursor-pointer hover:scale-[1.02]">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-neutral-400 uppercase tracking-wider">Total Tickets</p>
                                <p class="text-4xl font-bold text-white mt-2" id="kpi-total">-</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
                                <i class="fas fa-layer-group text-blue-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div onclick="kpiClick('open')" class="card rounded-xl p-6 transition-all duration-300 cursor-pointer hover:scale-[1.02]">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-neutral-400 uppercase tracking-wider">Open Tickets</p>
                                <p class="text-4xl font-bold text-amber-400 mt-2" id="kpi-open">-</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center">
                                <i class="fas fa-clock text-amber-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div onclick="kpiClick('closed')" class="card rounded-xl p-6 transition-all duration-300 cursor-pointer hover:scale-[1.02]">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-neutral-400 uppercase tracking-wider">Closed / Resolved
                                </p>
                                <p class="text-4xl font-bold text-emerald-400 mt-2" id="kpi-closed">-</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                                <i class="fas fa-check-circle text-emerald-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div onclick="kpiClick('critical')" class="card rounded-xl p-6 transition-all duration-300 cursor-pointer hover:scale-[1.02]">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-neutral-400 uppercase tracking-wider">Critical Open</p>
                                <p class="text-4xl font-bold text-red-500 mt-2" id="kpi-critical">-</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-white tracking-wide">Ticket Status</h3>
                            <span class="text-xs text-neutral-500">Distribution</span>
                        </div>
                        <div class="h-56"><canvas id="statusChart"></canvas></div>
                    </div>
                    <div class="card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-white tracking-wide">Priority Levels</h3>
                            <span class="text-xs text-neutral-500">Breakdown</span>
                        </div>
                        <div class="h-56"><canvas id="priorityChart"></canvas></div>
                    </div>
                </div>
                <!-- Charts Row 2 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-white tracking-wide">Top Request Types</h3>
                            <span class="text-xs text-neutral-500">By Volume</span>
                        </div>
                        <div class="h-64"><canvas id="requestTypeChart"></canvas></div>
                    </div>
                    <div class="card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-white tracking-wide">Staff Workload</h3>
                            <span class="text-xs text-neutral-500">Assigned vs Open</span>
                        </div>
                        <div class="h-64"><canvas id="workloadChart"></canvas></div>
                    </div>
                </div>

                <!-- Recent Tickets -->
                <div class="card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-semibold text-white">Recent Tickets</h3>
                        <a href="#" onclick="switchView('tickets')"
                            class="text-xs text-blue-400 hover:text-blue-300">View All →</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-xs text-neutral-500 uppercase border-b border-neutral-800">
                                <tr>
                                    <th class="py-3 text-left">ID</th>
                                    <th class="py-3 text-left">Title</th>
                                    <th class="py-3 text-center">Status</th>
                                    <th class="py-3 text-center">Priority</th>
                                    <th class="py-3 text-left">Assigned</th>
                                    <th class="py-3 text-left">Date</th>
                                </tr>
                            </thead>
                            <tbody id="recent-tickets"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: ALL TICKETS -->
            <div id="view-tickets" class="view-section hidden">
                <div class="card rounded-xl p-6 mb-6">
                    <div class="flex flex-col md:flex-row gap-4 justify-between">
                        <div class="relative flex-1 max-w-md">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500"></i>
                            <input type="text" id="ticket-search" onkeyup="filterTickets()" placeholder="Search..."
                                class="w-full bg-neutral-900 border border-neutral-700 rounded-lg pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex gap-3">
                            <select id="status-filter" onchange="filterTickets()"
                                class="bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2.5 text-sm">
                                <option value="">All Statuses</option>
                                <option value="Open">Open</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Waiting for Info">Waiting for Info</option>
                                <option value="Resolved">Resolved</option>
                                <option value="Closed">Closed</option>
                            </select>
                            <select id="priority-filter" onchange="filterTickets()"
                                class="bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2.5 text-sm">
                                <option value="">All Priorities</option>
                                <option value="Critical">Critical</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                            <select id="type-filter" onchange="filterTickets()"
                                class="bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2.5 text-sm">
                                <option value="">All Types</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card rounded-xl overflow-hidden">
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full text-sm">
                            <thead
                                class="text-xs text-neutral-500 uppercase border-b border-neutral-800 sticky top-0 bg-neutral-900">
                                <tr>
                                    <th class="py-3 px-4 text-left">ID</th>
                                    <th class="py-3 px-4 text-left">Title</th>
                                    <th class="py-3 px-4 text-center">Status</th>
                                    <th class="py-3 px-4 text-center">Priority</th>
                                    <th class="py-3 px-4 text-left">Type</th>
                                    <th class="py-3 px-4 text-left">Labels</th>
                                    <th class="py-3 px-4 text-left">Assigned</th>
                                    <th class="py-3 px-4 text-left">Date</th>
                                    <th class="py-3 px-4 text-center">Days</th>
                                </tr>
                            </thead>
                            <tbody id="all-tickets"></tbody>
                        </table>
                    </div>
                    <div class="border-t border-neutral-800 p-4 flex justify-between text-xs text-neutral-500">
                        <span>Showing <span id="ticket-count">0</span> tickets • Click any row for details</span>
                    </div>
                </div>
            </div>

            <!-- VIEW: KANBAN BOARD -->
            <div id="view-board" class="view-section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                    <!-- TO DO Column -->
                    <div class="kanban-column p-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded bg-red-500"></span>
                                <h3 class="text-sm font-semibold text-white uppercase tracking-wider">To Do</h3>
                            </div>
                            <span class="text-xs text-neutral-500 bg-neutral-800 px-2 py-0.5 rounded-full" id="count-todo">0</span>
                        </div>
                        <div id="kanban-todo" class="space-y-3 min-h-[100px]" data-column="TO DO"></div>
                    </div>
                    <!-- IN PROGRESS Column -->
                    <div class="kanban-column p-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded bg-blue-500"></span>
                                <h3 class="text-sm font-semibold text-white uppercase tracking-wider">In Progress</h3>
                            </div>
                            <span class="text-xs text-neutral-500 bg-neutral-800 px-2 py-0.5 rounded-full" id="count-inprogress">0</span>
                        </div>
                        <div id="kanban-inprogress" class="space-y-3 min-h-[100px]" data-column="IN PROGRESS"></div>
                    </div>
                    <!-- IN REVIEW Column -->
                    <div class="kanban-column p-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded bg-amber-500"></span>
                                <h3 class="text-sm font-semibold text-white uppercase tracking-wider">In Review</h3>
                            </div>
                            <span class="text-xs text-neutral-500 bg-neutral-800 px-2 py-0.5 rounded-full" id="count-inreview">0</span>
                        </div>
                        <div id="kanban-inreview" class="space-y-3 min-h-[100px]" data-column="IN REVIEW"></div>
                    </div>
                    <!-- DONE Column -->
                    <div class="kanban-column p-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-emerald-500 flex items-center justify-center">
                                    <i class="fas fa-check text-white" style="font-size:6px"></i>
                                </span>
                                <h3 class="text-sm font-semibold text-white uppercase tracking-wider">Done</h3>
                            </div>
                            <span class="text-xs text-neutral-500 bg-neutral-800 px-2 py-0.5 rounded-full" id="count-done">0</span>
                        </div>
                        <div id="kanban-done" class="space-y-3 min-h-[100px]" data-column="DONE"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: COLOR LEGEND -->
            <div id="view-legend" class="view-section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Status Colors -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2"><i
                                class="fas fa-palette text-blue-400"></i> Status Colors</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-emerald-500"></span>
                                <span class="font-medium text-white">Closed</span>
                                <span class="text-neutral-400 text-sm ml-auto">Ticket fully completed and archived</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-teal-500"></span>
                                <span class="font-medium text-white">Resolved</span>
                                <span class="text-neutral-400 text-sm ml-auto">Solution provided, awaiting confirmation</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-blue-500"></span>
                                <span class="font-medium text-white">In Progress</span>
                                <span class="text-neutral-400 text-sm ml-auto">Currently being worked on</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-amber-500"></span>
                                <span class="font-medium text-white">Waiting for Info</span>
                                <span class="text-neutral-400 text-sm ml-auto">Pending additional information from requester</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-red-500"></span>
                                <span class="font-medium text-white">Open</span>
                                <span class="text-neutral-400 text-sm ml-auto">Newly created, not yet assigned</span>
                            </div>
                        </div>
                    </div>
                    <!-- Priority Levels -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2"><i
                                class="fas fa-exclamation-triangle text-amber-400"></i> Priority Levels</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-red-500"></span>
                                <span class="font-medium text-red-400">Critical</span>
                                <span class="text-neutral-400 text-sm ml-auto">System-wide outages, needs immediate action</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-orange-500"></span>
                                <span class="font-medium text-orange-400">High</span>
                                <span class="text-neutral-400 text-sm ml-auto">Key business functions affected, 24-48h</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-amber-500"></span>
                                <span class="font-medium text-amber-400">Medium</span>
                                <span class="text-neutral-400 text-sm ml-auto">Individual users affected, some inconvenience</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-green-500"></span>
                                <span class="font-medium text-green-400">Low</span>
                                <span class="text-neutral-400 text-sm ml-auto">Minor issues, standard requests</span>
                            </div>
                        </div>
                    </div>
                    <!-- Kanban Board Columns -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2"><i
                                class="fas fa-columns text-indigo-400"></i> Kanban Board Columns</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-red-500"></span>
                                <span class="font-medium text-red-400">TO DO</span>
                                <span class="text-neutral-400 text-sm ml-auto">Tickets with "Open" status</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-blue-500"></span>
                                <span class="font-medium text-blue-400">IN PROGRESS</span>
                                <span class="text-neutral-400 text-sm ml-auto">Tickets with "In Progress" status</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-amber-500"></span>
                                <span class="font-medium text-amber-400">IN REVIEW</span>
                                <span class="text-neutral-400 text-sm ml-auto">Tickets with "Waiting for Info" status</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-emerald-500"></span>
                                <span class="font-medium text-emerald-400">DONE</span>
                                <span class="text-neutral-400 text-sm ml-auto">Tickets with "Resolved" or "Closed" status</span>
                            </div>
                        </div>
                    </div>
                    <!-- Days Open Indicators -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2"><i
                                class="fas fa-clock text-red-400"></i> Days Open Indicators</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-red-500"></span>
                                <span class="font-medium text-red-400">&gt; 7 Days (Alert)</span>
                                <span class="text-neutral-400 text-sm ml-auto">Requires immediate attention</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-amber-500"></span>
                                <span class="font-medium text-amber-400">4-7 Days (Warning)</span>
                                <span class="text-neutral-400 text-sm ml-auto">Should be prioritized</span>
                            </div>
                            <div class="flex items-center gap-4 p-3 bg-neutral-900/50 rounded-lg">
                                <span class="w-4 h-4 rounded bg-neutral-500"></span>
                                <span class="font-medium text-neutral-300">&lt; 4 Days</span>
                                <span class="text-neutral-400 text-sm ml-auto">Within normal SLA</span>
                            </div>
                        </div>
                    </div>
                    <!-- Labels Legend (dynamically loaded) -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2"><i
                                class="fas fa-tags text-purple-400"></i> Ticket Labels</h3>
                        <div id="legend-labels-container" class="space-y-3">
                            <div class="text-neutral-500 text-sm">Loading labels...</div>
                        </div>
                    </div>
                    <!-- Categories Legend (dynamically loaded) -->
                    <div class="card rounded-xl p-6 lg:col-span-2">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2"><i
                                class="fas fa-folder-open text-teal-400"></i> Request Categories</h3>
                        <div id="legend-categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            <div class="text-neutral-500 text-sm">Loading categories...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: TEAM -->
            <div id="view-team" class="view-section hidden">
                <div class="card rounded-xl p-6">
                    <h3 class="text-sm font-semibold text-white mb-6">Staff Workload Distribution</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-xs text-neutral-500 uppercase border-b border-neutral-800">
                                <tr>
                                    <th class="py-3 text-left">Staff Member</th>
                                    <th class="py-3 text-center">Assigned</th>
                                    <th class="py-3 text-center">Open</th>
                                    <th class="py-3 text-left">Workload</th>
                                </tr>
                            </thead>
                            <tbody id="team-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: USERS -->
            <div id="view-users" class="view-section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-users text-blue-400"></i> All Users
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-neutral-500 uppercase border-b border-neutral-800">
                                    <tr>
                                        <th class="py-3 text-left">Username</th>
                                        <th class="py-3 text-left">Display Name</th>
                                        <th class="py-3 text-center">Role</th>
                                        <th class="py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-user-plus text-green-400"></i> Create New User
                        </h3>
                        <form id="create-user-form" class="space-y-4">
                            <div>
                                <label class="block text-xs text-neutral-500 uppercase mb-1">Username</label>
                                <input type="text" id="new-username" required
                                    class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="block text-xs text-neutral-500 uppercase mb-1">Display Name</label>
                                <input type="text" id="new-display-name" required
                                    class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="block text-xs text-neutral-500 uppercase mb-1">Password</label>
                                <input type="password" id="new-password" required
                                    class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="block text-xs text-neutral-500 uppercase mb-1">Role</label>
                                <select id="new-role"
                                    class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                                    <option value="viewer">Viewer (Read-only)</option>
                                    <option value="admin">Admin (Full access)</option>
                                </select>
                            </div>
                            <button type="submit"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 rounded-lg transition">
                                <i class="fas fa-user-plus mr-2"></i> Create User
                            </button>
                        </form>
                        <div id="create-user-msg" class="mt-4 hidden"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="view-section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Change Password -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-key text-amber-400"></i> Change Password
                        </h3>
                        <form id="change-password-form" class="space-y-4">
                            <div>
                                <label class="block text-xs text-neutral-500 uppercase mb-1">Current Password</label>
                                <input type="password" id="current-password" required
                                    class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="block text-xs text-neutral-500 uppercase mb-1">New Password</label>
                                <input type="password" id="new-password-change" required
                                    class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="block text-xs text-neutral-500 uppercase mb-1">Confirm New Password</label>
                                <input type="password" id="confirm-password" required
                                    class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            </div>
                            <button type="submit"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition">
                                <i class="fas fa-save mr-2"></i> Update Password
                            </button>
                        </form>
                        <div id="change-password-msg" class="mt-4 hidden"></div>
                    </div>

                    <!-- Category Management (admin-only) -->
                    <div class="admin-only card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-folder text-blue-400"></i> Manage Categories
                        </h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto mb-4" id="category-list"></div>
                        <div class="border-t border-neutral-800 pt-4">
                            <div class="flex gap-2">
                                <input type="text" id="new-category-name" placeholder="New category name..."
                                    class="flex-1 bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-white text-sm">
                                <input type="color" id="new-category-color" value="#6366f1"
                                    class="w-10 h-10 rounded cursor-pointer bg-transparent border-0">
                                <button onclick="createCategory()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Label Management (admin-only) -->
                    <div class="admin-only card rounded-xl p-6 lg:col-span-2">
                        <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-tags text-amber-400"></i> Manage Labels
                        </h3>
                        <div class="flex flex-wrap gap-3 mb-4" id="label-list"></div>
                        <div class="border-t border-neutral-800 pt-4">
                            <div class="flex gap-2 items-center">
                                <input type="text" id="new-label-name" placeholder="New label name..."
                                    class="flex-1 bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-white text-sm max-w-xs">
                                <input type="color" id="new-label-color" value="#3b82f6"
                                    class="w-10 h-10 rounded cursor-pointer bg-transparent border-0">
                                <button onclick="createLabel()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- TICKET DETAIL MODAL -->
    <div id="ticket-modal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="modal-window bg-neutral-900 rounded-xl w-full max-w-2xl border border-neutral-700 overflow-hidden">
            <!-- Title Bar -->
            <div class="bg-neutral-950 px-4 py-3 flex items-center justify-between border-b border-neutral-700">
                <div class="flex items-center gap-3">
                    <span class="font-mono text-blue-400 text-sm" id="modal-ticket-id">IT-00000000</span>
                    <span id="modal-status-badge"></span>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="minimizeModal()"
                        class="w-8 h-8 rounded hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white"><i
                            class="fas fa-minus text-xs"></i></button>
                    <button onclick="maximizeModal()"
                        class="w-8 h-8 rounded hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white"><i
                            class="fas fa-expand text-xs"></i></button>
                    <button onclick="closeModal()"
                        class="w-8 h-8 rounded hover:bg-red-600 flex items-center justify-center text-neutral-400 hover:text-white"><i
                            class="fas fa-times"></i></button>
                </div>
            </div>
            <!-- Content -->
            <div class="p-6 max-h-[70vh] overflow-y-auto" id="modal-content">
                <h2 class="text-xl font-bold text-white mb-4" id="modal-title">Ticket Title</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-xs text-neutral-500 uppercase">Priority</p>
                        <p id="modal-priority" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-xs text-neutral-500 uppercase">Request Type</p>
                        <p id="modal-type" class="text-white"></p>
                    </div>
                    <div>
                        <p class="text-xs text-neutral-500 uppercase">Assigned To</p>
                        <p id="modal-assigned" class="text-white"></p>
                    </div>
                    <div>
                        <p class="text-xs text-neutral-500 uppercase">Requester</p>
                        <p id="modal-requester" class="text-white"></p>
                    </div>
                    <div>
                        <p class="text-xs text-neutral-500 uppercase">Date Opened</p>
                        <p id="modal-date" class="text-white"></p>
                    </div>
                    <div>
                        <p class="text-xs text-neutral-500 uppercase">Days Open</p>
                        <p id="modal-days" class="text-white"></p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-xs text-neutral-500 uppercase mb-1">Labels</p>
                        <div id="modal-labels" class="flex flex-wrap gap-1"></div>
                    </div>
                </div>
                <div class="mb-6">
                    <p class="text-xs text-neutral-500 uppercase mb-2">Description</p>
                    <div class="bg-neutral-950 p-4 rounded-lg text-neutral-300 text-sm" id="modal-description">-</div>
                </div>
                <div class="mb-6">
                    <p class="text-xs text-neutral-500 uppercase mb-2">Resolution Notes</p>
                    <div class="bg-neutral-950 p-4 rounded-lg text-neutral-300 text-sm" id="modal-resolution">-</div>
                </div>
                <div class="mb-6">
                    <p class="text-xs text-neutral-500 uppercase mb-2">Attachments</p>
                    <div id="modal-attachments" class="flex flex-wrap gap-3"></div>
                </div>
            </div>
            <!-- Actions -->
            <div class="bg-neutral-950 px-6 py-4 flex justify-between border-t border-neutral-700">
                <button onclick="deleteCurrentTicket()"
                    class="admin-only px-4 py-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 text-sm font-medium"><i
                        class="fas fa-trash mr-2"></i>Delete</button>
                <button onclick="editCurrentTicket()"
                    class="admin-only px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"><i
                        class="fas fa-edit mr-2"></i>Edit Ticket</button>
            </div>
        </div>
    </div>

    <!-- NEW/EDIT TICKET MODAL -->
    <div id="edit-modal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="modal-window bg-neutral-900 rounded-xl w-full max-w-xl border border-neutral-700 overflow-hidden">
            <div class="bg-neutral-950 px-4 py-3 flex items-center justify-between border-b border-neutral-700">
                <span class="font-semibold text-white" id="edit-modal-title">New Ticket</span>
                <button onclick="closeEditModal()"
                    class="w-8 h-8 rounded hover:bg-red-600 flex items-center justify-center text-neutral-400 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="ticket-form" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="form-ticket-id">
                <div>
                    <label class="block text-xs text-neutral-500 uppercase mb-1">Title <span class="text-red-500">*</span></label>
                    <input type="text" id="form-title"
                        class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500"
                        required placeholder="e.g., Server memory leak in production">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-neutral-500 uppercase mb-1">Status</label>
                        <select id="form-status"
                            class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            <option>Open</option>
                            <option>In Progress</option>
                            <option>Waiting for Info</option>
                            <option>Resolved</option>
                            <option>Closed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-neutral-500 uppercase mb-1">Priority</label>
                        <select id="form-priority"
                            class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                            <option>Low</option>
                            <option>Medium</option>
                            <option>High</option>
                            <option>Critical</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-neutral-500 uppercase mb-1">Request Type</label>
                        <select id="form-type"
                            class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white"
                            onchange="onRequestTypeChange(this)">
                        </select>
                        <div id="custom-type-container" class="hidden mt-2">
                            <div class="flex gap-2">
                                <input type="text" id="custom-type-input" placeholder="New category name..."
                                    class="flex-1 bg-neutral-950 border border-neutral-700 rounded-lg px-3 py-1.5 text-white text-sm">
                                <button type="button" onclick="addCustomCategory()"
                                    class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button type="button" onclick="cancelCustomCategory()"
                                    class="px-3 py-1.5 bg-neutral-700 text-white rounded-lg text-sm hover:bg-neutral-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-neutral-500 uppercase mb-1">Assigned To</label>
                        <input type="text" id="form-assigned"
                            class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-neutral-500 uppercase mb-1">Requester</label>
                    <input type="text" id="form-requester"
                        class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white">
                </div>
                <div>
                    <label class="block text-xs text-neutral-500 uppercase mb-1">Labels</label>
                    <div id="form-labels" class="flex flex-wrap gap-2 p-3 bg-neutral-950 border border-neutral-700 rounded-lg min-h-[40px]">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-neutral-500 uppercase mb-1">Description</label>
                    <textarea id="form-description" rows="3"
                        class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white"
                        placeholder="Add details, steps to reproduce, expected behavior..."></textarea>
                </div>
                <div>
                    <label class="block text-xs text-neutral-500 uppercase mb-1">Attachments</label>
                    <div id="form-attachments-preview" class="flex flex-wrap gap-3 mb-2"></div>
                    <label class="flex items-center gap-2 px-4 py-2 bg-neutral-950 border border-neutral-700 border-dashed rounded-lg cursor-pointer hover:border-neutral-500 transition text-sm text-neutral-400">
                        <i class="fas fa-paperclip"></i> Attach files (images, PDF, max 5MB)
                        <input type="file" id="form-file-input" class="hidden" accept="image/*,.pdf,.txt"
                            multiple onchange="handleFileSelect(this)">
                    </label>
                </div>
                <div>
                    <label class="block text-xs text-neutral-500 uppercase mb-1">Resolution Notes</label>
                    <textarea id="form-resolution" rows="2"
                        class="w-full bg-neutral-950 border border-neutral-700 rounded-lg px-4 py-2 text-white"></textarea>
                </div>
            </form>
            <div class="bg-neutral-950 px-6 py-4 flex justify-end gap-3 border-t border-neutral-700">
                <button onclick="closeEditModal()"
                    class="px-4 py-2 bg-neutral-700 text-white rounded-lg hover:bg-neutral-600 text-sm">Cancel</button>
                <button onclick="saveTicket()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"><i
                        class="fas fa-save mr-2"></i>Save</button>
            </div>
        </div>
    </div>

    <script>
        let allTickets = [];
        let statsData = {};
        let countdown = 30;
        let currentTicket = null;
        let currentUser = null;
        let pendingFiles = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            loadData();
            setInterval(() => { countdown--; document.getElementById('countdown').innerText = countdown; if (countdown <= 0) { loadData(); countdown = 30; } }, 1000);
        });

        async function loadUserInfo() {
            try {
                const res = await fetch('/api/me');
                if (res.ok) {
                    currentUser = await res.json();
                    const initials = currentUser.display_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    document.getElementById('user-avatar').innerText = initials;
                    document.getElementById('user-display-name').innerText = currentUser.display_name;
                    document.getElementById('user-role').innerText = currentUser.role === 'admin' ? 'Administrator' : 'Viewer';
                    applyRoleBasedUI();
                } else {
                    window.location.href = '/login';
                }
            } catch (e) { console.error('Error loading user:', e); }
        }

        function applyRoleBasedUI() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (e) { console.error('Logout error:', e); }
        }

        async function loadData() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            countdown = 30;
            try {
                const [statsRes, ticketsRes] = await Promise.all([fetch('/api/stats'), fetch('/api/tickets')]);
                statsData = await statsRes.json();
                allTickets = await ticketsRes.json();
                renderKPIs(statsData);
                renderCharts(statsData);
                renderRecentTickets(allTickets.slice(0, 8));
                renderAllTickets(allTickets);
                renderTeam(statsData.staff_workload);
                // Populate type filter
                await loadDropdownOptions();
                const typeFilter = document.getElementById('type-filter');
                if (typeFilter) {
                    const currentVal = typeFilter.value;
                    typeFilter.innerHTML = '<option value="">All Types</option>' +
                        dropdownOptions.request_types.map(t =>
                            `<option value="${t}" ${t === currentVal ? 'selected' : ''}>${t}</option>`
                        ).join('');
                }
            } catch (e) { console.error("Error:", e); }
            icon.classList.remove('fa-spin');
        }

        function renderKPIs(s) {
            document.getElementById('kpi-total').innerText = s.total;
            document.getElementById('kpi-open').innerText = s.open;
            document.getElementById('kpi-closed').innerText = s.closed;
            document.getElementById('kpi-critical').innerText = s.critical;
        }

        // Center text plugin for doughnut charts
        const centerTextPlugin = {
            id: 'centerText',
            afterDraw(chart) {
                if (chart.config.type !== 'doughnut') return;
                const cfg = chart.options.plugins && chart.options.plugins.centerText;
                if (!cfg) return;
                const { ctx } = chart;
                const { left, right, top, bottom } = chart.chartArea;
                const cx = (left + right) / 2;
                const cy = (top + bottom) / 2;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                // Main number
                const fontSize = cfg.fontSize || 26;
                ctx.font = 'bold ' + fontSize + 'px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillStyle = cfg.color || '#f5f5f5';
                ctx.fillText(String(cfg.text || ''), cx, cy - 7);
                // Subtext label
                ctx.font = '500 9px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillStyle = '#a3a3a3';
                ctx.fillText(String(cfg.subtext || ''), cx, cy + 12);
                ctx.restore();
            }
        };
        Chart.register(centerTextPlugin);
        Chart.defaults.color = '#e5e5e5';

        // Shared tooltip config
        const tooltipStyle = {
            backgroundColor: 'rgba(15,15,15,0.95)', titleColor: '#f5f5f5', bodyColor: '#d4d4d4',
            borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1, cornerRadius: 6,
            padding: { top: 10, bottom: 10, left: 14, right: 14 },
            displayColors: true, boxPadding: 6, titleFont: { weight: '600', size: 12 },
            bodyFont: { size: 11 }, caretSize: 5,
            callbacks: { label: function(ctx) { const total = ctx.dataset.data.reduce((a, b) => a + b, 0); const pct = total ? ((ctx.raw / total) * 100).toFixed(1) : 0; return ` ${ctx.label}: ${ctx.raw} (${pct}%)`; } }
        };

        // Fixed color maps so each value always gets the same distinct color
        const statusColorMap = {
            'Open': '#ef4444', 'In Progress': '#3b82f6', 'Waiting for Info': '#f59e0b',
            'Resolved': '#8b5cf6', 'Closed': '#22c55e'
        };
        const priorityColorMap = {
            'Critical': '#ef4444', 'High': '#f97316', 'Medium': '#facc15',
            'Low': '#22c55e', 'None': '#a3a3a3'
        };

        function renderCharts(s) {
            const total = Object.values(s.statuses).reduce((a, b) => a + b, 0);
            const critCount = s.priorities['Critical'] || 0;
            const statusColors = Object.keys(s.statuses).map(k => statusColorMap[k] || '#6b7280');
            createDoughnutChart('statusChart', s.statuses, statusColors,
                { text: String(total), subtext: 'TOTAL', color: '#ffffff' });
            const priorityColors = Object.keys(s.priorities).map(k => priorityColorMap[k] || '#6b7280');
            createDoughnutChart('priorityChart', s.priorities, priorityColors,
                { text: String(critCount), subtext: 'CRITICAL', color: critCount > 0 ? '#ef4444' : '#ffffff' });
            createHorizontalBarChart('requestTypeChart', s.request_types);
            createWorkloadChart('workloadChart', s.staff_workload);
        }

        function createDoughnutChart(id, data, colors, centerCfg) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (window[id] instanceof Chart) window[id].destroy();
            window[id] = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverBorderWidth: 0,
                        hoverOffset: 4,
                        spacing: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '72%',
                    layout: { padding: { left: 0, right: 0 } },
                    animation: { animateRotate: true, duration: 800, easing: 'easeOutQuart' },
                    plugins: {
                        centerText: centerCfg,
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#ffffff', font: { size: 11, family: 'Inter, system-ui, sans-serif' },
                                usePointStyle: true, pointStyle: 'rectRounded', pointStyleWidth: 10, padding: 14,
                                generateLabels: function(chart) {
                                    const ds = chart.data.datasets[0];
                                    return chart.data.labels.map((label, i) => ({
                                        text: `${label}  ${ds.data[i]}`,
                                        fillStyle: ds.backgroundColor[i],
                                        strokeStyle: 'transparent',
                                        fontColor: '#ffffff',
                                        hidden: false, index: i
                                    }));
                                }
                            }
                        },
                        tooltip: { ...tooltipStyle }
                    }
                }
            });
        }

        function createHorizontalBarChart(id, data) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (window[id] instanceof Chart) window[id].destroy();
            const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const barColors = ['#818cf8','#60a5fa','#34d399','#fbbf24','#f87171','#a78bfa','#fb923c','#38bdf8','#f472b6','#2dd4bf'];
            window[id] = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(x => x[0]),
                    datasets: [{
                        data: sorted.map(x => x[1]),
                        backgroundColor: sorted.map((_, i) => barColors[i % barColors.length]),
                        hoverBackgroundColor: sorted.map((_, i) => barColors[i % barColors.length] + 'cc'),
                        borderRadius: 4,
                        borderSkipped: false,
                        barPercentage: 0.7,
                        categoryPercentage: 0.85
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15,15,15,0.95)', titleColor: '#f5f5f5', bodyColor: '#d4d4d4',
                            borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1, cornerRadius: 6,
                            padding: { top: 10, bottom: 10, left: 14, right: 14 }, caretSize: 5,
                            callbacks: { label: function(ctx) { return ` ${ctx.raw} tickets`; } }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#525252', font: { size: 10 } },
                            grid: { color: 'rgba(255,255,255,0.04)', drawTicks: false },
                            border: { display: false }
                        },
                        y: {
                            ticks: { color: '#d4d4d4', font: { size: 11, family: 'Inter, system-ui, sans-serif' }, padding: 8 },
                            grid: { display: false },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        function createWorkloadChart(id, workload) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (window[id] instanceof Chart) window[id].destroy();
            const staff = Object.entries(workload).sort((a, b) => b[1].assigned - a[1].assigned).slice(0, 8);
            if (staff.length === 0) {
                ctx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-neutral-500 text-sm">No staff data available</div>';
                return;
            }
            window[id] = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: staff.map(s => s[0]),
                    datasets: [
                        {
                            label: 'Assigned',
                            data: staff.map(s => s[1].assigned),
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            hoverBackgroundColor: 'rgba(99, 102, 241, 0.9)',
                            borderRadius: 4, borderSkipped: false,
                            barPercentage: 0.6, categoryPercentage: 0.8
                        },
                        {
                            label: 'Open',
                            data: staff.map(s => s[1].open),
                            backgroundColor: 'rgba(251, 146, 60, 0.7)',
                            hoverBackgroundColor: 'rgba(251, 146, 60, 0.9)',
                            borderRadius: 4, borderSkipped: false,
                            barPercentage: 0.6, categoryPercentage: 0.8
                        }
                    ]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    plugins: {
                        legend: {
                            position: 'top', align: 'end',
                            labels: {
                                color: '#a3a3a3', font: { size: 10, family: 'Inter, system-ui, sans-serif' },
                                usePointStyle: true, pointStyle: 'rectRounded', pointStyleWidth: 10, padding: 16, boxHeight: 8
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15,15,15,0.95)', titleColor: '#f5f5f5', bodyColor: '#d4d4d4',
                            borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1, cornerRadius: 6,
                            padding: { top: 10, bottom: 10, left: 14, right: 14 }, caretSize: 5,
                            callbacks: { label: function(ctx) { return ` ${ctx.dataset.label}: ${ctx.raw} tickets`; } }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            ticks: { color: '#525252', font: { size: 10 }, stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.04)', drawTicks: false },
                            border: { display: false }
                        },
                        y: {
                            stacked: false,
                            ticks: { color: '#d4d4d4', font: { size: 11, family: 'Inter, system-ui, sans-serif' }, padding: 8 },
                            grid: { display: false },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        function getStatusBadge(status) {
            const colors = { 'Closed': 'bg-emerald-500/20 text-emerald-400', 'Resolved': 'bg-teal-500/20 text-teal-400', 'In Progress': 'bg-blue-500/20 text-blue-400', 'Waiting for Info': 'bg-amber-500/20 text-amber-400' };
            return `<span class="px-2 py-1 rounded text-xs font-medium ${colors[status] || 'bg-red-500/20 text-red-400'}">${status}</span>`;
        }

        function getPriorityText(priority) {
            const colors = { 'Critical': 'text-red-500 font-bold', 'High': 'text-orange-400 font-semibold', 'Medium': 'text-amber-400', 'Low': 'text-green-400' };
            return `<span class="${colors[priority] || 'text-neutral-400'}">${priority}</span>`;
        }

        function renderLabelChips(labels) {
            return (labels || []).map(l =>
                `<span class="label-chip" style="background:${l.color}22;color:${l.color}">${l.name}</span>`
            ).join(' ');
        }

        function renderRecentTickets(tickets) {
            document.getElementById('recent-tickets').innerHTML = tickets.map(t => `
                <tr class="ticket-row border-b border-neutral-800/50" onclick="openTicketModal('${t.ticket_id}')">
                    <td class="py-3 font-mono text-xs text-blue-400">${t.ticket_id}</td>
                    <td class="py-3 text-white max-w-xs truncate">${t.title}</td>
                    <td class="py-3 text-center">${getStatusBadge(t.status)}</td>
                    <td class="py-3 text-center">${getPriorityText(t.priority)}</td>
                    <td class="py-3 text-neutral-400">${t.staff_assigned || '-'}</td>
                    <td class="py-3 text-neutral-500 text-xs">${t.date_opened}</td>
                </tr>
            `).join('');
        }

        function renderAllTickets(tickets) {
            document.getElementById('all-tickets').innerHTML = tickets.map(t => {
                let daysClass = 'text-neutral-500';
                if (t.days_open !== '-' && typeof t.days_open === 'number') {
                    daysClass = t.days_open > 7 ? 'text-red-400 font-bold' : t.days_open > 4 ? 'text-amber-400' : 'text-neutral-500';
                }
                return `
                    <tr class="ticket-row border-b border-neutral-800/50" onclick="openTicketModal('${t.ticket_id}')">
                        <td class="py-3 px-4 font-mono text-xs text-blue-400">${t.ticket_id}</td>
                        <td class="py-3 px-4 text-white max-w-sm truncate">${t.title}</td>
                        <td class="py-3 px-4 text-center">${getStatusBadge(t.status)}</td>
                        <td class="py-3 px-4 text-center text-xs">${getPriorityText(t.priority)}</td>
                        <td class="py-3 px-4 text-neutral-400 text-xs">${t.request_type || '-'}</td>
                        <td class="py-3 px-4">${renderLabelChips(t.labels)}</td>
                        <td class="py-3 px-4 text-neutral-400">${t.staff_assigned || '-'}</td>
                        <td class="py-3 px-4 text-neutral-500 text-xs">${t.date_opened}</td>
                        <td class="py-3 px-4 text-center text-xs ${daysClass}">${t.days_open}</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('ticket-count').innerText = tickets.length;
        }

        function filterTickets() {
            const search = document.getElementById('ticket-search').value.toLowerCase();
            const status = document.getElementById('status-filter').value;
            const priority = document.getElementById('priority-filter').value;
            const type = document.getElementById('type-filter').value;
            const filtered = allTickets.filter(t => {
                const matchSearch = t.ticket_id.toLowerCase().includes(search) || t.title.toLowerCase().includes(search) || (t.staff_assigned || '').toLowerCase().includes(search);
                return matchSearch && (!status || t.status === status) && (!priority || t.priority === priority) && (!type || t.request_type === type);
            });
            renderAllTickets(filtered);
        }

        function kpiClick(type) {
            switchView('tickets');
            const statusFilter = document.getElementById('status-filter');
            const priorityFilter = document.getElementById('priority-filter');
            const typeFilter = document.getElementById('type-filter');
            statusFilter.value = '';
            priorityFilter.value = '';
            typeFilter.value = '';
            document.getElementById('ticket-search').value = '';

            if (type === 'open') {
                const filtered = allTickets.filter(t => t.status !== 'Closed' && t.status !== 'Resolved');
                renderAllTickets(filtered);
            } else if (type === 'closed') {
                const filtered = allTickets.filter(t => t.status === 'Closed' || t.status === 'Resolved');
                renderAllTickets(filtered);
            } else if (type === 'critical') {
                priorityFilter.value = 'Critical';
                const filtered = allTickets.filter(t => t.priority === 'Critical' && t.status !== 'Closed' && t.status !== 'Resolved');
                renderAllTickets(filtered);
            } else {
                renderAllTickets(allTickets);
            }
        }

        function renderTeam(workload) {
            const tbody = document.getElementById('team-table');
            if (!workload) return;
            const maxOpen = Math.max(...Object.values(workload).map(x => x.open), 1);
            tbody.innerHTML = Object.entries(workload).map(([name, data]) => {
                const pct = Math.round((data.open / maxOpen) * 100);
                const color = data.open > 5 ? 'bg-red-500' : data.open > 2 ? 'bg-amber-500' : 'bg-emerald-500';
                return `<tr class="border-b border-neutral-800/50"><td class="py-3 text-white font-medium">${name}</td><td class="py-3 text-center text-neutral-300">${data.assigned}</td><td class="py-3 text-center font-bold ${data.open > 5 ? 'text-red-400' : 'text-emerald-400'}">${data.open}</td><td class="py-3"><div class="h-2 bg-neutral-800 rounded-full w-32"><div class="${color} h-full rounded-full" style="width:${pct}%"></div></div></td></tr>`;
            }).join('');
        }

        function switchView(name) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + name).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + name).classList.add('active');
            const titles = {
                dashboard: ['Dashboard Overview', ''],
                tickets: ['All Tickets', 'Click any row for full details'],
                board: ['Kanban Board', 'Drag tickets between columns to update status'],
                legend: ['Color Legend', 'Status, priority, board, labels and category references'],
                team: ['Team Workload', 'Staff assignment distribution'],
                users: ['User Management', 'Create and manage user accounts'],
                settings: ['Settings', 'Account preferences and system configuration']
            };
            document.getElementById('page-title').innerText = titles[name][0];
            document.getElementById('page-subtitle').innerText = titles[name][1];

            if (name === 'users') loadUsers();
            if (name === 'board') loadKanbanBoard();
            if (name === 'legend') loadLegendData();
            if (name === 'settings') { loadCategoryList(); loadLabelList(); }
        }

        async function loadLegendData() {
            try {
                const [labelsRes, catsRes] = await Promise.all([
                    fetch('/api/labels'), fetch('/api/categories')
                ]);
                const labels = await labelsRes.json();
                const categories = await catsRes.json();
                const lc = document.getElementById('legend-labels-container');
                if (labels.length === 0) {
                    lc.innerHTML = '<div class="text-neutral-500 text-sm">No labels configured</div>';
                } else {
                    lc.innerHTML = labels.map(l => {
                        const c = l.color || '#3b82f6';
                        return `<div class="flex items-center gap-3 p-3 bg-neutral-900/50 rounded-lg">
                            <span class="w-4 h-4 rounded flex-shrink-0" style="background-color:${c}"></span>
                            <span class="font-medium text-white text-sm flex-1">${l.name}</span>
                            <span class="px-2 py-0.5 rounded text-xs font-medium flex-shrink-0" style="background-color:${c}20;color:${c}">${l.name}</span>
                        </div>`;
                    }).join('');
                }
                const cc = document.getElementById('legend-categories-container');
                if (categories.length === 0) {
                    cc.innerHTML = '<div class="text-neutral-500 text-sm">No categories configured</div>';
                } else {
                    cc.innerHTML = categories.map(c => {
                        const clr = c.color || '#6366f1';
                        return `<div class="flex items-center gap-3 p-2.5 bg-neutral-900/50 rounded-lg">
                            <span class="w-3 h-3 rounded flex-shrink-0" style="background-color:${clr}"></span>
                            <i class="fas ${c.icon || 'fa-tag'} text-xs flex-shrink-0" style="color:${clr}"></i>
                            <span class="font-medium text-white text-sm truncate">${c.name}</span>
                        </div>`;
                    }).join('');
                }
            } catch (e) { console.error('Error loading legend data:', e); }
        }

        // --- KANBAN BOARD ---
        async function loadKanbanBoard() {
            try {
                const res = await fetch('/api/kanban');
                const columns = await res.json();
                renderKanbanColumn('kanban-todo', columns['TO DO'] || [], 'count-todo');
                renderKanbanColumn('kanban-inprogress', columns['IN PROGRESS'] || [], 'count-inprogress');
                renderKanbanColumn('kanban-inreview', columns['IN REVIEW'] || [], 'count-inreview');
                renderKanbanColumn('kanban-done', columns['DONE'] || [], 'count-done');
                initKanbanDragDrop();
            } catch (e) { console.error('Error loading kanban:', e); }
        }

        function renderKanbanColumn(containerId, tickets, countId) {
            const container = document.getElementById(containerId);
            document.getElementById(countId).innerText = tickets.length;
            const priorityBorders = { 'Critical': 'border-l-red-500', 'High': 'border-l-orange-500', 'Medium': 'border-l-amber-500', 'Low': 'border-l-green-500' };

            container.innerHTML = tickets.map(t => {
                const borderClass = priorityBorders[t.priority] || 'border-l-neutral-500';
                const labelsHtml = (t.labels || []).map(l =>
                    `<span class="label-chip" style="background:${l.color}22;color:${l.color}">${l.name}</span>`
                ).join('');
                const assigneeInitials = t.staff_assigned ?
                    t.staff_assigned.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase() : '';

                return `
                    <div class="kanban-card border-l-4 ${borderClass}" data-ticket-id="${t.ticket_id}" onclick="openTicketModal('${t.ticket_id}')">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-mono text-xs text-blue-400">${t.ticket_id}</span>
                            ${getPriorityText(t.priority)}
                        </div>
                        <p class="text-sm text-white font-medium mb-2 line-clamp-2">${t.title}</p>
                        ${labelsHtml ? `<div class="flex flex-wrap gap-1 mb-2">${labelsHtml}</div>` : ''}
                        <div class="flex items-center justify-between mt-2 pt-2 border-t border-neutral-800">
                            <span class="text-xs text-neutral-500">${t.request_type || ''}</span>
                            ${t.staff_assigned ? `
                                <div class="flex items-center gap-1.5">
                                    <div class="w-5 h-5 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-[8px] font-bold">${assigneeInitials}</div>
                                    <span class="text-xs text-neutral-400">${t.staff_assigned.split(' ')[0]}</span>
                                </div>
                            ` : '<span class="text-xs text-neutral-600">Unassigned</span>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function initKanbanDragDrop() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            ['kanban-todo', 'kanban-inprogress', 'kanban-inreview', 'kanban-done'].forEach(id => {
                const el = document.getElementById(id);
                if (el._sortable) el._sortable.destroy();
                el._sortable = new Sortable(el, {
                    group: 'kanban',
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    disabled: !isAdmin,
                    onEnd: async function(evt) {
                        const ticketId = evt.item.dataset.ticketId;
                        const targetColumn = evt.to.dataset.column;
                        try {
                            const res = await fetch(`/api/tickets/${ticketId}/move`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ column: targetColumn })
                            });
                            if (!res.ok) { loadKanbanBoard(); }
                            else { updateKanbanCounts(); loadData(); }
                        } catch (e) { console.error('Move failed:', e); loadKanbanBoard(); }
                    }
                });
            });
        }

        function updateKanbanCounts() {
            ['todo', 'inprogress', 'inreview', 'done'].forEach(col => {
                const container = document.getElementById(`kanban-${col}`);
                document.getElementById(`count-${col}`).innerText = container.querySelectorAll('.kanban-card').length;
            });
        }

        // --- MODAL FUNCTIONS ---
        async function openTicketModal(ticketId) {
            currentTicket = allTickets.find(t => t.ticket_id === ticketId);
            if (!currentTicket) return;
            document.getElementById('modal-ticket-id').innerText = currentTicket.ticket_id;
            document.getElementById('modal-status-badge').innerHTML = getStatusBadge(currentTicket.status);
            document.getElementById('modal-title').innerText = currentTicket.title;
            document.getElementById('modal-priority').innerHTML = getPriorityText(currentTicket.priority);
            document.getElementById('modal-type').innerText = currentTicket.request_type || '-';
            document.getElementById('modal-assigned').innerText = currentTicket.staff_assigned || '-';
            document.getElementById('modal-requester').innerText = currentTicket.requester || '-';
            document.getElementById('modal-date').innerText = currentTicket.date_opened || '-';
            document.getElementById('modal-days').innerText = currentTicket.days_open || '0';
            document.getElementById('modal-description').innerText = currentTicket.description || 'No description provided.';
            document.getElementById('modal-resolution').innerText = currentTicket.resolution_notes || 'No resolution notes yet.';
            // Labels
            document.getElementById('modal-labels').innerHTML = renderLabelChips(currentTicket.labels) || '<span class="text-neutral-500 text-xs">None</span>';
            // Attachments
            await loadModalAttachments(currentTicket.ticket_id);
            document.getElementById('ticket-modal').classList.remove('hidden');
        }

        async function loadModalAttachments(ticketId) {
            const container = document.getElementById('modal-attachments');
            try {
                const res = await fetch(`/api/tickets/${ticketId}/attachments`);
                const attachments = await res.json();
                if (attachments.length === 0) {
                    container.innerHTML = '<span class="text-neutral-500 text-xs">No attachments</span>';
                    return;
                }
                container.innerHTML = attachments.map(a => {
                    if (a.mime_type.startsWith('image/')) {
                        return `<a href="/api/attachments/${a.id}" target="_blank" title="${a.original_name}">
                            <img src="/api/attachments/${a.id}" class="attachment-preview" alt="${a.original_name}">
                        </a>`;
                    }
                    return `<a href="/api/attachments/${a.id}" target="_blank"
                        class="flex items-center gap-2 px-3 py-2 bg-neutral-950 rounded-lg border border-neutral-700 hover:border-neutral-500 text-sm text-neutral-300">
                        <i class="fas fa-file text-neutral-400"></i> ${a.original_name}
                        <span class="text-neutral-500 text-xs">${(a.file_size / 1024).toFixed(0)}KB</span>
                    </a>`;
                }).join('');
            } catch (e) {
                container.innerHTML = '<span class="text-neutral-500 text-xs">Error loading attachments</span>';
            }
        }

        function closeModal() { document.getElementById('ticket-modal').classList.add('hidden'); currentTicket = null; }
        function minimizeModal() { document.querySelector('#ticket-modal .modal-window').classList.toggle('scale-75'); }
        function maximizeModal() { document.querySelector('#ticket-modal .modal-window').classList.toggle('max-w-2xl'); document.querySelector('#ticket-modal .modal-window').classList.toggle('max-w-5xl'); }

        // --- CRUD FUNCTIONS ---
        let dropdownOptions = { request_types: [], categories: [], labels: [], staff: [], requesters: [] };

        async function loadDropdownOptions() {
            try {
                const res = await fetch('/api/options');
                dropdownOptions = await res.json();
            } catch (e) { console.error('Error loading options:', e); }
        }

        function populateRequestTypeDropdown(selectedType = '') {
            const typeSelect = document.getElementById('form-type');
            typeSelect.innerHTML = '<option value="">Select...</option>' +
                dropdownOptions.request_types.map(t =>
                    `<option value="${t}" ${t === selectedType ? 'selected' : ''}>${t}</option>`
                ).join('') +
                '<option value="__custom__">+ Add Custom Category...</option>';
        }

        function onRequestTypeChange(select) {
            if (select.value === '__custom__') {
                document.getElementById('custom-type-container').classList.remove('hidden');
                select.value = '';
            }
        }

        async function addCustomCategory() {
            const name = document.getElementById('custom-type-input').value.trim();
            if (!name) return;
            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    await loadDropdownOptions();
                    populateRequestTypeDropdown(name);
                    document.getElementById('form-type').value = name;
                    cancelCustomCategory();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Error creating category');
                }
            } catch (e) { alert('Network error'); }
        }

        function cancelCustomCategory() {
            document.getElementById('custom-type-container').classList.add('hidden');
            document.getElementById('custom-type-input').value = '';
        }

        function populateLabelsSelector(selectedLabelIds = []) {
            const container = document.getElementById('form-labels');
            if (!container) return;
            container.innerHTML = (dropdownOptions.labels || []).map(l => {
                const isSelected = selectedLabelIds.includes(l.id);
                return `<span class="label-select-chip label-chip ${isSelected ? 'selected' : ''}"
                    style="background:${l.color}22;color:${l.color};border-color:${isSelected ? l.color : 'transparent'}"
                    data-label-id="${l.id}" onclick="toggleLabel(this,'${l.color}')">${l.name}</span>`;
            }).join('');
            if ((dropdownOptions.labels || []).length === 0) {
                container.innerHTML = '<span class="text-neutral-500 text-xs">No labels available. Create labels in Settings.</span>';
            }
        }

        function toggleLabel(el, color) {
            el.classList.toggle('selected');
            el.style.borderColor = el.classList.contains('selected') ? color : 'transparent';
        }

        function getSelectedLabelIds() {
            return Array.from(document.querySelectorAll('#form-labels .label-select-chip.selected'))
                .map(el => parseInt(el.dataset.labelId));
        }

        // File handling
        function handleFileSelect(input) {
            const preview = document.getElementById('form-attachments-preview');
            for (const file of input.files) {
                if (file.size > 5 * 1024 * 1024) { alert(`File "${file.name}" exceeds 5MB limit`); continue; }
                pendingFiles.push(file);
                const div = document.createElement('div');
                div.className = 'relative';
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'attachment-preview';
                    img.src = URL.createObjectURL(file);
                    img.title = file.name;
                    div.appendChild(img);
                } else {
                    div.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-neutral-950 rounded-lg border border-neutral-700 text-xs text-neutral-300">
                        <i class="fas fa-file"></i> ${file.name}
                    </div>`;
                }
                const removeBtn = document.createElement('button');
                removeBtn.className = 'absolute -top-1 -right-1 w-5 h-5 bg-red-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-500';
                removeBtn.innerHTML = '<i class="fas fa-times" style="font-size:8px"></i>';
                removeBtn.type = 'button';
                const idx = pendingFiles.length - 1;
                removeBtn.onclick = () => { pendingFiles[idx] = null; div.remove(); };
                div.appendChild(removeBtn);
                preview.appendChild(div);
            }
            input.value = '';
        }

        async function uploadPendingFiles(ticketId) {
            const filesToUpload = pendingFiles.filter(f => f !== null);
            for (const file of filesToUpload) {
                const formData = new FormData();
                formData.append('file', file);
                try {
                    await fetch(`/api/tickets/${ticketId}/attachments`, { method: 'POST', body: formData });
                } catch (e) { console.error('Upload error:', e); }
            }
            pendingFiles = [];
        }

        async function openNewTicketModal() {
            await loadDropdownOptions();
            populateRequestTypeDropdown();
            populateLabelsSelector([]);
            pendingFiles = [];
            document.getElementById('form-attachments-preview').innerHTML = '';
            document.getElementById('edit-modal-title').innerText = 'New Ticket';
            document.getElementById('form-ticket-id').value = '';
            document.getElementById('form-title').value = '';
            document.getElementById('form-status').value = 'Open';
            document.getElementById('form-priority').value = 'Low';
            document.getElementById('form-type').value = '';
            document.getElementById('form-assigned').value = '';
            document.getElementById('form-requester').value = '';
            document.getElementById('form-description').value = '';
            document.getElementById('form-resolution').value = '';
            cancelCustomCategory();
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        async function editCurrentTicket() {
            if (!currentTicket) return;
            const ticket = { ...currentTicket };
            closeModal();
            await loadDropdownOptions();
            populateRequestTypeDropdown(ticket.request_type);
            populateLabelsSelector((ticket.labels || []).map(l => l.id));
            pendingFiles = [];
            document.getElementById('form-attachments-preview').innerHTML = '';
            // Load existing attachments for preview
            try {
                const res = await fetch(`/api/tickets/${ticket.ticket_id}/attachments`);
                const attachments = await res.json();
                const preview = document.getElementById('form-attachments-preview');
                attachments.forEach(a => {
                    const div = document.createElement('div');
                    div.className = 'relative';
                    if (a.mime_type.startsWith('image/')) {
                        div.innerHTML = `<img src="/api/attachments/${a.id}" class="attachment-preview" title="${a.original_name}">`;
                    } else {
                        div.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-neutral-950 rounded-lg border border-neutral-700 text-xs text-neutral-300">
                            <i class="fas fa-file"></i> ${a.original_name}</div>`;
                    }
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'admin-only absolute -top-1 -right-1 w-5 h-5 bg-red-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-500';
                    removeBtn.innerHTML = '<i class="fas fa-times" style="font-size:8px"></i>';
                    removeBtn.type = 'button';
                    removeBtn.onclick = async () => {
                        if (confirm('Delete this attachment?')) {
                            await fetch(`/api/attachments/${a.id}`, { method: 'DELETE' });
                            div.remove();
                        }
                    };
                    div.appendChild(removeBtn);
                    preview.appendChild(div);
                });
            } catch (e) { console.error('Error loading attachments:', e); }

            document.getElementById('edit-modal-title').innerText = 'Edit ' + ticket.ticket_id;
            document.getElementById('form-ticket-id').value = ticket.ticket_id;
            document.getElementById('form-title').value = ticket.title;
            document.getElementById('form-status').value = ticket.status;
            document.getElementById('form-priority').value = ticket.priority;
            document.getElementById('form-assigned').value = ticket.staff_assigned || '';
            document.getElementById('form-requester').value = ticket.requester || '';
            document.getElementById('form-description').value = ticket.description || '';
            document.getElementById('form-resolution').value = ticket.resolution_notes || '';
            cancelCustomCategory();
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); pendingFiles = []; }

        async function saveTicket() {
            const ticketId = document.getElementById('form-ticket-id').value;
            const labelIds = getSelectedLabelIds();
            const data = {
                title: document.getElementById('form-title').value,
                status: document.getElementById('form-status').value,
                priority: document.getElementById('form-priority').value,
                request_type: document.getElementById('form-type').value,
                staff_assigned: document.getElementById('form-assigned').value,
                requester: document.getElementById('form-requester').value,
                description: document.getElementById('form-description').value,
                resolution_notes: document.getElementById('form-resolution').value,
                label_ids: labelIds
            };
            if (!data.title.trim()) { alert('Title is required'); return; }
            try {
                const url = ticketId ? `/api/tickets/${ticketId}` : '/api/tickets';
                const method = ticketId ? 'PUT' : 'POST';
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (res.ok) {
                    const result = await res.json();
                    const savedTicketId = ticketId || result.ticket_id;
                    // Update labels for existing tickets
                    if (ticketId) {
                        await fetch(`/api/tickets/${ticketId}/labels`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ label_ids: labelIds })
                        });
                    }
                    // Upload pending files
                    if (pendingFiles.filter(f => f !== null).length > 0) {
                        await uploadPendingFiles(savedTicketId);
                    }
                    closeEditModal();
                    loadData();
                } else { alert('Error saving ticket'); }
            } catch (e) { alert('Network error'); }
        }

        async function deleteCurrentTicket() {
            if (!currentTicket || !confirm(`Delete ticket ${currentTicket.ticket_id}?`)) return;
            try {
                const res = await fetch(`/api/tickets/${currentTicket.ticket_id}`, { method: 'DELETE' });
                if (res.ok) { closeModal(); loadData(); } else { alert('Error deleting'); }
            } catch (e) { alert('Network error'); }
        }

        // --- CATEGORY MANAGEMENT ---
        async function loadCategoryList() {
            try {
                const res = await fetch('/api/categories');
                const categories = await res.json();
                document.getElementById('category-list').innerHTML = categories.map(c => `
                    <div class="flex items-center gap-3 p-2 bg-neutral-900/50 rounded-lg">
                        <span class="w-4 h-4 rounded flex-shrink-0" style="background:${c.color}"></span>
                        <i class="fas ${c.icon} text-neutral-400 text-xs w-4 flex-shrink-0"></i>
                        <span class="text-sm text-white flex-1">${c.name}</span>
                        ${c.is_custom ? `<button onclick="deleteCategory(${c.id})" class="text-red-400 hover:text-red-300 text-xs"><i class="fas fa-trash"></i></button>` :
                        '<span class="text-xs text-neutral-600">Default</span>'}
                    </div>
                `).join('');
            } catch (e) { console.error('Error loading categories:', e); }
        }

        async function createCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            const color = document.getElementById('new-category-color').value;
            if (!name) { alert('Category name is required'); return; }
            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, color })
                });
                if (res.ok) {
                    document.getElementById('new-category-name').value = '';
                    loadCategoryList();
                    loadDropdownOptions();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Error creating category');
                }
            } catch (e) { alert('Network error'); }
        }

        async function deleteCategory(id) {
            if (!confirm('Deactivate this category? Existing tickets will keep their type.')) return;
            try {
                await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                loadCategoryList();
                loadDropdownOptions();
            } catch (e) { alert('Network error'); }
        }

        // --- LABEL MANAGEMENT ---
        async function loadLabelList() {
            try {
                const res = await fetch('/api/labels');
                const labels = await res.json();
                document.getElementById('label-list').innerHTML = labels.map(l => `
                    <div class="flex items-center gap-2 p-2 bg-neutral-900/50 rounded-lg">
                        <span class="label-chip" style="background:${l.color}22;color:${l.color}">${l.name}</span>
                        <button onclick="deleteLabel(${l.id})" class="text-red-400 hover:text-red-300 text-xs ml-1"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
                if (labels.length === 0) {
                    document.getElementById('label-list').innerHTML = '<span class="text-neutral-500 text-sm">No labels yet. Create one below.</span>';
                }
            } catch (e) { console.error('Error loading labels:', e); }
        }

        async function createLabel() {
            const name = document.getElementById('new-label-name').value.trim().toUpperCase();
            const color = document.getElementById('new-label-color').value;
            if (!name) { alert('Label name is required'); return; }
            try {
                const res = await fetch('/api/labels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, color })
                });
                if (res.ok) {
                    document.getElementById('new-label-name').value = '';
                    loadLabelList();
                    loadDropdownOptions();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Error creating label');
                }
            } catch (e) { alert('Network error'); }
        }

        async function deleteLabel(id) {
            if (!confirm('Delete this label? It will be removed from all tickets.')) return;
            try {
                await fetch(`/api/labels/${id}`, { method: 'DELETE' });
                loadLabelList();
                loadDropdownOptions();
            } catch (e) { alert('Network error'); }
        }

        // --- USER MANAGEMENT ---
        let allUsers = [];

        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                if (res.ok) { allUsers = await res.json(); renderUsers(); }
            } catch (e) { console.error('Error loading users:', e); }
        }

        function renderUsers() {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = allUsers.map(u => `
                <tr class="border-b border-neutral-800/50">
                    <td class="py-3">${u.username}</td>
                    <td class="py-3">${u.display_name}</td>
                    <td class="py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs font-medium ${u.role === 'admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-neutral-500/20 text-neutral-400'}">
                            ${u.role === 'admin' ? 'Admin' : 'Viewer'}
                        </span>
                    </td>
                    <td class="py-3 text-right">
                        ${u.username === 'admin' ? '<span class="text-xs text-neutral-500">Protected</span>' :
                    `<button onclick="deleteUser('${u.username}')" class="text-red-400 hover:text-red-300 text-sm"><i class="fas fa-trash"></i></button>`}
                    </td>
                </tr>
            `).join('');
        }

        async function deleteUser(username) {
            if (!confirm(`Delete user ${username}?`)) return;
            try {
                const res = await fetch(`/api/users/${username}`, { method: 'DELETE' });
                if (res.ok) { loadUsers(); } else { alert('Error deleting user'); }
            } catch (e) { alert('Network error'); }
        }

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgEl = document.getElementById('create-user-msg');
            const data = {
                username: document.getElementById('new-username').value,
                display_name: document.getElementById('new-display-name').value,
                password: document.getElementById('new-password').value,
                role: document.getElementById('new-role').value
            };
            try {
                const res = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    msgEl.className = 'mt-4 p-3 rounded bg-green-500/20 text-green-400 text-sm';
                    msgEl.textContent = 'User created successfully!';
                    msgEl.classList.remove('hidden');
                    document.getElementById('create-user-form').reset();
                    loadUsers();
                } else {
                    msgEl.className = 'mt-4 p-3 rounded bg-red-500/20 text-red-400 text-sm';
                    msgEl.textContent = result.error || 'Error creating user';
                    msgEl.classList.remove('hidden');
                }
            } catch (e) {
                msgEl.className = 'mt-4 p-3 rounded bg-red-500/20 text-red-400 text-sm';
                msgEl.textContent = 'Network error';
                msgEl.classList.remove('hidden');
            }
        });

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgEl = document.getElementById('change-password-msg');
            const newPass = document.getElementById('new-password-change').value;
            const confirmPass = document.getElementById('confirm-password').value;
            if (newPass !== confirmPass) {
                msgEl.className = 'mt-4 p-3 rounded bg-red-500/20 text-red-400 text-sm';
                msgEl.textContent = 'Passwords do not match';
                msgEl.classList.remove('hidden');
                return;
            }
            try {
                const res = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: document.getElementById('current-password').value,
                        new_password: newPass
                    })
                });
                const result = await res.json();
                if (res.ok) {
                    msgEl.className = 'mt-4 p-3 rounded bg-green-500/20 text-green-400 text-sm';
                    msgEl.textContent = 'Password updated successfully!';
                    msgEl.classList.remove('hidden');
                    document.getElementById('change-password-form').reset();
                } else {
                    msgEl.className = 'mt-4 p-3 rounded bg-red-500/20 text-red-400 text-sm';
                    msgEl.textContent = result.error || 'Error changing password';
                    msgEl.classList.remove('hidden');
                }
            } catch (e) {
                msgEl.className = 'mt-4 p-3 rounded bg-red-500/20 text-red-400 text-sm';
                msgEl.textContent = 'Network error';
                msgEl.classList.remove('hidden');
            }
        });
    </script>
</body>

</html>
